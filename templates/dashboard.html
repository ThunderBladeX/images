<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Manager Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 2rem; }
        .container { max-width: 1200px; margin: auto; }
        h1, h2 { color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }
        .form-card, .image-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input, select, textarea { width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 1rem; }
        textarea { min-height: 80px; }
        button, .button { background-color: #1877f2; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; text-decoration: none; display: inline-block; text-align: center; }
        button:hover, .button:hover { background-color: #166fe5; }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .image-item { border: 1px solid #ddd; border-radius: 6px; overflow: hidden; position: relative; }
        .image-item img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .image-info { padding: 0.75rem; }
        .image-title { font-weight: bold; margin: 0 0 0.5rem; }
        .image-meta { font-size: 0.8rem; color: #666; }
        .actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .copy-btn, .delete-btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; border-radius: 4px; flex-grow: 1; }
        .delete-btn { background-color: #e44d3a; }
        .delete-btn:hover { background-color: #c83b2a; }
        .edit-btn { background-color: #f0ad4e; color: white; border: none; font-size: 0.8rem; padding: 0.3rem 0.6rem; border-radius: 4px; flex-grow: 1; cursor: pointer; }
        .edit-btn:hover { background-color: #ec971f; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; z-index: 1000; }
        .checkbox-label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .checkbox-label input { width: auto; margin-bottom: 0; }
        .logout-btn { background-color: #6c757d; }
        .logout-btn:hover { background-color: #5a6268; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Alathea's Art Manager</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        <div class="grid">
            <div class="form-card">
                <h2>Upload New Artwork</h2>
                <form id="uploadForm">
                    <label for="file">Image File</label>
                    <input type="file" id="file" name="file" accept="image/*" required>
                    
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" required>

                    <label for="alt_text">Alt Text (optional, for screen readers)</label>
                    <input type="text" id="alt_text" name="alt_text" placeholder="Defaults to title if left blank">
                    
                    <label for="year_made">Year Made</label>
                    <input type="number" id="year_made" name="year_made" placeholder="e.g., 2023" required>
                    
                    <label for="month_made">Month Made (optional)</label>
                    <input type="number" id="month_made" name="month_made" placeholder="1-12" min="1" max="12">
                    
                    <label for="day_made">Day Made (optional)</label>
                    <input type="number" id="day_made" name="day_made" placeholder="1-31" min="1" max="31">
                    
                    <label for="color_tag">Color Tag</label>
                    <select id="color_tag" name="color_tag" required>
                        <!-- Options will be populated by JS -->
                    </select>

                    <label for="description">Description (optional)</label>
                    <textarea id="description" name="description"></textarea>
                    
                    <label for="credit_text">Credit Text (optional)</label>
                    <input type="text" id="credit_text" name="credit_text" placeholder="e.g., Character by Jane Doe">
                    
                    <label for="credit_url">Credit URL (optional)</label>
                    <input type="url" id="credit_url" name="credit_url" placeholder="e.g., https://janedoe.social">

                    <label class="checkbox-label">
                        <input type="checkbox" id="is_sensitive" name="is_sensitive" value="true"> Is Sensitive Content (16+)?
                    </label>
                    <button type="submit">Upload & Update Gallery</button>
                    <button type="button" id="cancelEditBtn" style="display: none; background-color: #6c757d; margin-top: 0.5rem;" class="button">Cancel Edit</button>
                </form>
                <hr style="margin: 2rem 0; border: 1px solid #eee;">
                <h2>Manual Sync</h2>
                <button onclick="manualUpdate()">Force Update Neocities Gallery</button>
            </div>
            
            <div class="image-card">
                <h2>Uploaded Images (<span id="imageCount">0</span>)</h2>
                <div class="image-gallery" id="imageGallery">
                    <!-- Images will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
    <div id="toast"></div>

    <script>
        const toast = document.getElementById('toast');
        const token = localStorage.getItem('accessToken');
        let editingImageId = null;
        const colorTags = {{ color_tags | tojson }};

        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#e44d3a' : '#333';
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 3000);
        }

        function getAuthHeader() {
            return { 'Authorization': `Bearer ${token}` };
        }

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...getAuthHeader(),
                    ...options.headers,
                },
            });

            if (response.status === 401) {
                logout();
                return;
            }
            return response;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Markdown URL copied!');
            }, (err) => {
                showToast('Failed to copy!', true);
            });
        }

        async function deleteImage(imageId) {
            if (!confirm('Are you sure you want to delete this image? This will also update Neocities.')) return;
            
            try {
                const response = await fetchWithAuth(`/api/delete/${imageId}`, { method: 'DELETE' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || data.message);
                showToast(data.message || 'Image deleted.');
                fetchImages();
            } catch (error) {
                showToast(`Error: ${error.message}`, true);
            }
        }

        function startEdit(image) {
            editingImageId = image.id;
            
            document.getElementById('title').value = image.title || '';
            document.getElementById('alt_text').value = image.alt_text || '';
            document.getElementById('year_made').value = image.year_made || '';
            document.getElementById('month_made').value = image.month_made || '';
            document.getElementById('day_made').value = image.day_made || '';
            document.getElementById('color_tag').value = image.color_tag || '';
            document.getElementById('description').value = image.description || '';
            document.getElementById('credit_text').value = image.credit_text || '';
            document.getElementById('credit_url').value = image.credit_url || '';
            document.getElementById('is_sensitive').checked = image.is_sensitive;
            
            document.querySelector('.form-card h2').textContent = 'Edit Artwork Details';
            document.querySelector('#uploadForm button[type="submit"]').textContent = 'Save Changes';

            const fileInput = document.getElementById('file');
            fileInput.disabled = true;
            fileInput.required = false;

            document.getElementById('cancelEditBtn').style.display = 'block';
            document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingImageId = null;
            const form = document.getElementById('uploadForm');
            form.reset();

            document.querySelector('.form-card h2').textContent = 'Upload New Artwork';
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.textContent = 'Upload & Update Gallery';
            submitButton.disabled = false;

            const fileInput = document.getElementById('file');
            fileInput.disabled = false;
            fileInput.required = true;

            document.getElementById('cancelEditBtn').style.display = 'none';
        }
        
        async function manualUpdate() {
            showToast('Triggering Neocities update...');
            try {
                const response = await fetchWithAuth('/api/update-gallery', { method: 'POST' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || data.message);
                showToast(data.message || 'Update complete.');
            } catch (error) {
                showToast(`Error: ${error.message}`, true);
            }
        }
        
        async function handleUpload(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');

            let url, method, op_verb, op_gerund;

            if (editingImageId) {
                url = `/api/images/${editingImageId}`;
                method = 'PUT';
                formData.delete('file');
                op_verb = 'Saving';
                op_gerund = 'Saving changes...';
            } else {
                url = '/api/upload';
                method = 'POST';
                op_verb = 'Uploading';
                op_gerund = 'Uploading...';
            }
            
            submitButton.disabled = true;
            submitButton.textContent = `${op_verb}...`;
            showToast(op_gerund);

            try {
                const response = await fetchWithAuth(url, {
                    method: method,
                    body: formData,
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || data.message);
                
                showToast(data.message || `${op_verb} successful!`);
                cancelEdit();
                fetchImages();
            } catch (error) {
                showToast(`${op_verb} failed: ${error.message}`, true);
            }
        }

        function renderImages(images) {
            const gallery = document.getElementById('imageGallery');
            const imageCount = document.getElementById('imageCount');
            gallery.innerHTML = '';
            imageCount.textContent = images.length;

            images.forEach(image => {
                const item = document.createElement('div');
                item.className = 'image-item';
                let dateString = image.year_made;
                if (image.month_made) {
                    dateString += `-${String(image.month_made).padStart(2, '0')}`;
                    if (image.day_made) {dateString += `-${String(image.day_made).padStart(2, '0')}`;
                                        }
                }
                const safeImageJson = JSON.stringify(image).replace(/"/g, '"');
                const safeMarkdownUrl = image.markdown_url.replace(/"/g, '"');
                
                item.innerHTML = `
                    <img src="${image.supabase_url}" alt="${image.title}">
                    <div class="image-info">
                        <p class="image-title">${image.title}</p>
                        <p class="image-meta">${dateString} | <span style="color:${image.color_tag};">‚óè</span> ${image.color_tag}</p>
                        <div class="actions">
                            <button class="copy-btn button" onclick="copyToClipboard('${safeMarkdownUrl}')">Copy MD</button>
                            <button class="edit-btn" data-image='${safeImageJson}' onclick="startEdit(JSON.parse(this.dataset.image))">Edit</button>
                            <button class="delete-btn" onclick="deleteImage(${image.id})">Delete</button>
                        </div>
                    </div>
                `;
                gallery.appendChild(item);
            });
        }
        
        async function fetchImages() {
             try {
                const response = await fetchWithAuth('/api/images');
                if (!response.ok) throw new Error('Failed to fetch images.');
                const images = await response.json();
                renderImages(images);
            } catch (error) {
                showToast(error.message, true);
            }
        }
        
        function populateColorOptions() {
            const select = document.getElementById('color_tag');
            select.innerHTML = colorTags.map(color => `<option value="${color}">${color.charAt(0).toUpperCase() + color.slice(1)}</option>`).join('');
        }

        function logout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/login';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
            populateColorOptions();
            fetchImages();
        });
    </script>
</body>
</html>
